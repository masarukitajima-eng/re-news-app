name: ä¸å‹•ç”£ãƒ‹ãƒ¥ãƒ¼ã‚¹è‡ªå‹•æ›´æ–° & Vercel ãƒ‡ãƒ—ãƒ­ã‚¤

on:
  schedule:
    # JST (UTC+9) â†’ UTC ã«å¤‰æ›
    - cron: '0 22 * * *'   # 07:00 JST
    - cron: '0 3 * * *'    # 12:00 JST
    - cron: '0 8 * * *'    # 17:00 JST
    - cron: '0 11 * * *'   # 20:00 JST
  workflow_dispatch:        # æ‰‹å‹•å®Ÿè¡Œãƒœã‚¿ãƒ³

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write       # ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã«å¿…è¦

    steps:
      # â”€â”€ 1. ã‚³ãƒ¼ãƒ‰ã‚’å–å¾— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0    # å…¨å±¥æ­´å–å¾—ï¼ˆgit push ã«å¿…è¦ï¼‰

      # â”€â”€ 2. Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # â”€â”€ 3. ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install dependencies
        run: npm ci

      # â”€â”€ 4. Google News RSS ã‹ã‚‰ãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—ãƒ»è‹±èªžè¨˜äº‹ã¯ Claude ã§ç¿»è¨³ â”€â”€
      - name: Fetch latest news (Google News RSS + Claude ç¿»è¨³)
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: node scripts/fetch-and-update.js

      # â”€â”€ 5. å¤‰æ›´ãŒã‚ã‚‹ã‹ç¢ºèª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Check for changes
        id: diff
        run: |
          if git diff --quiet src/data/mockNews.ts; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "æ–°ã—ã„è¨˜äº‹ãªã— â†’ ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚­ãƒƒãƒ—"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            COUNT=$(git diff --stat src/data/mockNews.ts | tail -1)
            echo "å¤‰æ›´ã‚ã‚Š: $COUNT"
          fi

      # â”€â”€ 6. ã‚³ãƒŸãƒƒãƒˆ & ãƒ—ãƒƒã‚·ãƒ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Commit & push
        if: steps.diff.outputs.changed == 'true'
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add src/data/mockNews.ts
          DATETIME=$(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M JST')
          git commit -m "chore: ä¸å‹•ç”£ãƒ‹ãƒ¥ãƒ¼ã‚¹è‡ªå‹•æ›´æ–° ${DATETIME}"
          git push

      # â”€â”€ 7. Vercel æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy to Vercel
        if: steps.diff.outputs.changed == 'true'
        env:
          VERCEL_TOKEN:      ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID:     team_DoaGsm2e48mHgnEsC5wxa88c
          VERCEL_PROJECT_ID: prj_ZCGA39a4ZoIFefUeTSK333Qv45AP
        run: |
          npm install -g vercel@latest --quiet
          vercel deploy --prod --token "$VERCEL_TOKEN" --yes

      # â”€â”€ 8. ã‚µãƒžãƒªãƒ¼å‡ºåŠ› â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Summary
        if: always()
        run: |
          echo "## å®Ÿè¡Œçµæžœ" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.diff.outputs.changed }}" = "true" ]; then
            echo "âœ… ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’æ›´æ–°ã—ã¦ Vercel ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— https://re-news-app.vercel.app" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ æ–°ã—ã„è¨˜äº‹ãªã—ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚­ãƒƒãƒ—ï¼‰" >> $GITHUB_STEP_SUMMARY
          fi
          echo "â° å®Ÿè¡Œæ™‚åˆ»: $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M JST')" >> $GITHUB_STEP_SUMMARY
